<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arogyam - AI Health Assistant</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons for modern UI elements -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles & Customizations --- */
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Tailwind's slate-50 */
        }
        
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Page transition animation */
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-page { display: block; }

        /* Enhanced chat bubble styling */
        .chat-bubble { max-width: 85%; transition: all 0.3s ease; }
        .user-bubble { background-color: #4f46e5; color: white; border-radius: 20px 20px 5px 20px; align-self: flex-end; }
        .bot-bubble { background-color: #eef2ff; color: #374151; border-radius: 20px 20px 20px 5px; align-self: flex-start; }
        
        /* Styling for active tabs and nav links */
        .tab-active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .nav-link-active { color: #4f46e5; font-weight: 600; }

        /* Typing indicator animation */
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            border-radius: 50%; display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="text-slate-700 antialiased">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-lg border-b border-slate-200">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="text-3xl font-bold text-indigo-600 flex items-center">
                        <i data-lucide="heart-pulse" class="w-8 h-8 mr-3"></i> Arogyam
                    </div>
                    <nav class="hidden md:flex items-center space-x-10">
                        <a href="#" data-page="home" class="nav-link nav-link-active text-slate-700 hover:text-indigo-600 transition-colors">Home</a>
                        <a href="#" data-page="chat-assistant" class="nav-link text-slate-500 hover:text-indigo-600 transition-colors">AI Assistant</a>
                        <a href="#" data-page="symptom-checker" class="nav-link text-slate-500 hover:text-indigo-600 transition-colors">Symptom Checker</a>
                        <a href="#" data-page="connect-doctor" class="nav-link text-slate-500 hover:text-indigo-600 transition-colors">Find a Doctor</a>
                    </nav>
                     <div class="md:hidden">
                         <button id="mobile-menu-button" class="text-slate-600 hover:text-indigo-700">
                             <i data-lucide="menu" class="w-8 h-8"></i>
                         </button>
                     </div>
                </div>
            </div>
             <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden hidden bg-white border-t p-2">
                 <a href="#" data-page="home" class="nav-link nav-link-active block py-3 text-center font-semibold">Home</a>
                 <a href="#" data-page="chat-assistant" class="nav-link text-slate-600 block py-3 text-center font-medium">AI Assistant</a>
                 <a href="#" data-page="symptom-checker" class="nav-link text-slate-600 block py-3 text-center font-medium">Symptom Checker</a>
                 <a href="#" data-page="connect-doctor" class="nav-link text-slate-600 block py-3 text-center font-medium">Find a Doctor</a>
            </div>
        </header>

        <main class="p-4 md:p-8">
            <div class="max-w-4xl mx-auto">
                <!-- Home Page -->
                <div id="home" class="page active-page">
                    <div class="text-center py-16">
                        <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 leading-tight mb-6">Intelligent Health Analysis at Your Fingertips</h1>
                        <p class="text-lg text-slate-600 mb-12 max-w-2xl mx-auto">Our advanced AI helps you understand your symptoms. Choose your preferred method below to begin.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-gradient-to-br from-indigo-600 to-indigo-800 text-white p-10 rounded-2xl shadow-2xl shadow-indigo-200 cursor-pointer hover:shadow-indigo-300 hover:-translate-y-2 transition-all duration-300 flex flex-col items-center text-center" onclick="navigateTo('chat-assistant')">
                                <i data-lucide="bot" class="w-16 h-16 mb-4"></i>
                                <h2 class="text-3xl font-bold">Chat with AI Assistant</h2>
                                <p class="mt-2 opacity-90">The fastest way to get answers. Just describe how you're feeling.</p>
                            </div>
                            <div class="bg-white p-10 rounded-2xl shadow-lg border border-slate-200 cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all duration-300 flex flex-col items-center text-center" onclick="navigateTo('symptom-checker')">
                                <i data-lucide="clipboard-list" class="w-16 h-16 mb-4 text-indigo-600"></i>
                                <h2 class="text-3xl font-bold text-slate-800">Use Symptom Checker</h2>
                                <p class="mt-2 text-slate-500">A step-by-step form to select symptoms from our organized list.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symptom Checker Page -->
                <div id="symptom-checker" class="page">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-10">
                        <h2 class="text-4xl font-bold text-slate-800 mb-8 text-center">Symptom Checker</h2>
                        <form id="health-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                                <div><label for="age" class="block text-sm font-medium text-slate-700 mb-2">Age</label><input type="number" id="age" name="age" class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 35" required></div>
                                <div><label for="gender" class="block text-sm font-medium text-slate-700 mb-2">Gender</label><select id="gender" name="gender" class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div>
                            </div>
                            <div class="mb-8"><label for="symptom-search" class="block text-lg font-semibold text-slate-800 mb-4">Select Your Symptoms</label><input type="text" id="symptom-search" class="w-full px-4 py-3 border border-slate-300 rounded-lg shadow-sm mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Search to filter symptoms..."><div id="symptom-categories" class="space-y-4"></div></div>
                            <div class="text-center"><button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-4 px-12 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105 text-lg">Analyze My Symptoms</button></div>
                        </form>
                    </div>
                </div>

                <!-- AI Chat Assistant Page -->
                <div id="chat-assistant" class="page h-[80vh]">
                    <div class="bg-white rounded-xl shadow-lg h-full flex flex-col">
                        <div id="chat-box" class="flex-1 p-6 overflow-y-auto custom-scrollbar flex flex-col space-y-6">
                            <!-- Chat messages appear here -->
                        </div>
                        <div class="p-4 border-t bg-slate-50 rounded-b-xl"><form id="chat-form" class="flex items-center space-x-4"><input type="text" id="chat-input" class="flex-1 w-full px-5 py-4 border border-slate-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="Type your symptoms here..." autocomplete="off" required><button type="submit" class="bg-indigo-600 text-white rounded-full p-4 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform hover:scale-110"><i data-lucide="send-horizontal" class="w-6 h-6"></i></button></form></div>
                    </div>
                </div>
                
                <!-- Connect with a Doctor Page -->
                <div id="connect-doctor" class="page">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-10">
                        <h2 class="text-4xl font-bold text-slate-800 mb-10 text-center">Find a Specialist</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div class="border rounded-xl p-8 text-center hover:shadow-2xl transition-shadow duration-300 bg-white flex flex-col items-center">
                                <img src="https://placehold.co/128x128/E0E7FF/3730A3?text=EC" alt="Dr. Emily Carter" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                                <h3 class="text-2xl font-bold mt-5">Dr. Emily Carter</h3>
                                <p class="text-slate-500">Cardiologist</p>
                                <button class="mt-6 w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">Book Appointment</button>
                            </div>
                            <div class="border rounded-xl p-8 text-center hover:shadow-2xl transition-shadow duration-300 bg-white flex flex-col items-center">
                                <img src="https://placehold.co/128x128/E0E7FF/3730A3?text=BA" alt="Dr. Ben Adams" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                                <h3 class="text-2xl font-bold mt-5">Dr. Ben Adams</h3>
                                <p class="text-slate-500">Dermatologist</p>
                                <button class="mt-6 w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">Book Appointment</button>
                            </div>
                            <div class="border rounded-xl p-8 text-center hover:shadow-2xl transition-shadow duration-300 bg-white flex flex-col items-center">
                                <img src="https://placehold.co/128x128/E0E7FF/3730A3?text=OC" alt="Dr. Olivia Chen" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                                <h3 class="text-2xl font-bold mt-5">Dr. Olivia Chen</h3>
                                <p class="text-slate-500">Gastroenterologist</p>
                                <button class="mt-6 w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition-colors">Book Appointment</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Universal Results Section -->
                <div id="results-section" class="page">
                    <div class="max-w-4xl mx-auto">
                        <div id="results-content">
                            <!-- Dynamic content will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- NEW: Disease Details Page -->
                <div id="disease-details" class="page">
                     <!-- Dynamic content will be injected here -->
                </div>

                 <!-- Footer -->
                <footer class="text-center py-10 mt-10 border-t text-slate-500">
                    <p>&copy; 2025 Arogyam. All rights reserved.</p>
                    <p class="text-sm mt-2">This tool is for informational purposes only and is not a substitute for professional medical advice.</p>
                </footer>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const symptomCategories = { "Common": ['itching', 'skin_rash', 'fatigue', 'high_fever', 'headache', 'nausea', 'vomiting', 'cough'], "Head & Neck": ['ulcers_on_tongue', 'patches_in_throat', 'sunken_eyes', 'pain_behind_the_eyes', 'yellowing_of_eyes', 'throat_irritation', 'redness_of_eyes', 'sinus_pressure', 'runny_nose', 'congestion', 'neck_pain', 'dizziness', 'puffy_face_and_eyes', 'enlarged_thyroid', 'drying_and_tingling_lips', 'slurred_speech', 'stiff_neck', 'loss_of_smell'], "Skin": ['nodal_skin_eruptions', 'yellowish_skin', 'dischromic_patches', 'pus_filled_pimples', 'blackheads', 'scurring', 'skin_peeling', 'silver_like_dusting', 'small_dents_in_nails', 'inflammatory_nails', 'blister', 'red_sore_around_nose', 'yellow_crust_ooze', 'bruising', 'red_spots_over_body'], "Abdominal & Digestive": ['stomach_pain', 'acidity', 'indigestion', 'constipation', 'abdominal_pain', 'diarrhoea', 'swelling_of_stomach', 'pain_during_bowel_movements', 'pain_in_anal_region', 'bloody_stool', 'irritation_in_anus', 'passage_of_gases', 'belly_pain', 'stomach_bleeding', 'distention_of_abdomen'], "Chest & Respiratory": ['continuous_sneezing', 'shivering', 'chills', 'breathlessness', 'sweating', 'phlegm', 'chest_pain', 'mucoid_sputum', 'rusty_sputum', 'blood_in_sputum'], "Systemic & General": ['joint_pain', 'muscle_wasting', 'weight_gain', 'anxiety', 'cold_hands_and_feets', 'mood_swings', 'weight_loss', 'restlessness', 'lethargy', 'irregular_sugar_level', 'dehydration', 'loss_of_appetite', 'mild_fever', 'acute_liver_failure', 'fluid_overload', 'swelled_lymph_nodes', 'malaise', 'weakness_in_limbs', 'fast_heart_rate', 'obesity', 'swollen_legs', 'swollen_blood_vessels', 'swollen_extremeties', 'excessive_hunger', 'muscle_weakness', 'swelling_joints', 'movement_stiffness', 'muscle_pain', 'polyuria', 'family_history', 'palpitations', 'painful_walking'], "Urinary": ['burning_micturition', 'spotting_urination', 'dark_urine', 'yellow_urine', 'bladder_discomfort', 'foul_smell_of_urine', 'continuous_feel_of_urine'], "Neurological": ['blurred_and_distorted_vision', 'spinning_movements', 'loss_of_balance', 'unsteadiness', 'weakness_of_one_body_side', 'altered_sensorium', 'coma'] };
            const allSymptoms = Object.values(symptomCategories).flat();
            const diseaseData = { 'Fungal infection': { description: 'A common skin condition caused by a fungus.', precautions: ['Maintain good hygiene', 'Keep skin dry'], diet: ['Avoid sugary foods', 'Eat garlic and yogurt', 'Consume leafy greens'], remedies: ['Apply tea tree oil diluted with a carrier oil.', 'Use apple cider vinegar soaks.', 'Keep the affected area clean and dry.'] }, 'Allergy': { description: 'An overreaction of the immune system to certain substances.', precautions: ['Identify and avoid allergens', 'Carry an antihistamine'], diet: ['Eat foods rich in quercetin (apples, onions)', 'Consume ginger and turmeric', 'Stay hydrated'], remedies: ['Use a saline nasal rinse.', 'Try local honey to potentially reduce pollen allergies.', 'Apply a cold compress to itchy areas.'] }, 'GERD': { description: 'A digestive disorder affecting the esophagus.', precautions: ['Avoid trigger foods (spicy, fatty)', 'Eat smaller meals', 'Do not lie down immediately after eating'], diet: ['Oatmeal and whole grains', 'Lean meats', 'Non-citrus fruits like bananas', 'Ginger tea'], remedies: ['Drink chamomile tea.', 'Chew sugar-free gum after meals to increase saliva production.', 'Elevate the head of your bed while sleeping.'] }, 'Diabetes ': { description: 'A chronic disease related to insulin production or use.', precautions: ['Monitor blood sugar', 'Regular exercise', 'Follow medication plan'], diet: ['Low-glycemic index foods', 'High-fiber vegetables', 'Lean protein (fish, chicken)', 'Healthy fats (avocado, nuts)'], remedies: ['Drink cinnamon tea.', 'Incorporate fenugreek seeds into your diet.', 'Manage stress through yoga or meditation.'] }, 'Gastroenteritis': { description: 'An inflammation of the intestines.', precautions: ['Stay hydrated', 'Practice good hand hygiene'], diet: ['BRAT diet (bananas, rice, applesauce, toast)', 'Clear broths and electrolyte drinks', 'Avoid dairy and fatty foods'], remedies: ['Drink ginger or peppermint tea to soothe nausea.', 'Sip on rice water.', 'Get plenty of rest.'] }, 'Hypertension ': { description: 'A condition of high blood pressure.', precautions: ['Low-sodium diet', 'Regular exercise', 'Limit alcohol'], diet: ['DASH diet (fruits, vegetables, whole grains)', 'Potassium-rich foods (bananas, spinach)', 'Limit caffeine and alcohol'], remedies: ['Practice deep breathing exercises.', 'Eat garlic regularly.', 'Drink hibiscus tea.'] }, 'Migraine': { description: 'A type of headache causing severe throbbing pain.', precautions: ['Identify and avoid triggers', 'Get enough sleep'], diet: ['Magnesium-rich foods (almonds, spinach)', 'Omega-3 fatty acids (salmon)', 'Stay hydrated', 'Avoid aged cheeses and processed meats'], remedies: ['Apply a cold or warm compress to your forehead.', 'Rest in a quiet, dark room.', 'Gently massage your neck and temples.'] }, 'Heart attack': { description: 'A medical emergency where blood flow to the heart is blocked.', precautions: ['Maintain a healthy diet', 'Exercise regularly', 'Do not smoke'], diet: ['Mediterranean diet', 'Foods low in saturated fat and cholesterol', 'High-fiber foods', 'Limit salt intake'], remedies: ['Home remedies are not a substitute for immediate medical attention. Call emergency services first.', 'Chew an aspirin if recommended by a medical professional.'] }, 'Pneumonia': { description: 'An infection that inflames the air sacs in one or both lungs.', precautions: ['Get vaccinated', 'Practice good hygiene', 'Do not smoke'], diet: ['Plenty of fluids (water, broth, tea)', 'Protein-rich foods (eggs, chicken)', 'Honey to soothe cough', 'Vitamin C-rich fruits'], remedies: ['Use a humidifier to ease breathing.', 'Drink warm turmeric milk.', 'Gargle with salt water to soothe a sore throat.'] }, 'Common Cold': { description: 'A common viral infection of your nose and throat.', precautions: ['Wash hands frequently', 'Get enough rest'], diet: ['Chicken soup', 'Citrus fruits for Vitamin C', 'Ginger and garlic', 'Plenty of fluids'], remedies: ['Gargle with warm salt water.', 'Drink honey and lemon tea.', 'Use a humidifier or steam inhalation.'] }, 'Jaundice': { description: 'A condition where the skin and eyes turn yellow due to high bilirubin.', precautions: ['Get vaccinated for Hepatitis', 'Avoid alcohol'], diet: ['Drink plenty of water', 'Eat fruits and vegetables', 'Whole grains', 'Avoid processed and fatty foods'], remedies: ['Drink barley water.', 'Consume sugarcane juice.', 'Eat tomatoes, which are rich in lycopene.'] }, 'Malaria': { description: 'A mosquito-borne disease caused by a parasite.', precautions: ['Use mosquito nets', 'Take anti-malarial drugs'], diet: ['High-calorie diet with plenty of fluids', 'Fruits like oranges and papaya', 'Easy-to-digest foods like khichdi'], remedies: ['Drink grapefruit juice.', 'Consume ginger tea.', 'Ensure complete rest.'] }, 'Chicken pox': { description: 'A contagious disease caused by the varicella-zoster virus.', precautions: ['Get vaccinated', 'Avoid scratching'], diet: ['Soft and bland foods', 'Plenty of fluids', 'Avoid spicy and acidic foods'], remedies: ['Take an oatmeal bath to relieve itching.', 'Apply calamine lotion.', 'Keep fingernails short to prevent skin infections from scratching.'] }, 'Dengue': { description: 'A mosquito-borne viral infection.', precautions: ['Use mosquito repellent', 'Eliminate standing water'], diet: ['Papaya leaf juice', 'Pomegranate and other fruits', 'Plenty of fluids and coconut water'], remedies: ['Drink barley grass juice.', 'Consume fenugreek leaves tea.', 'Get adequate rest.'] }, 'Typhoid': { description: 'A bacterial infection causing high fever.', precautions: ['Get vaccinated', 'Drink clean water'], diet: ['High-calorie, soft diet', 'Well-cooked foods', 'Bananas, boiled potatoes', 'Avoid raw vegetables and spicy food'], remedies: ['Drink plenty of oral rehydration solution (ORS).', 'Apply cold compresses to your forehead.', 'Eat garlic cloves on an empty stomach.'] } };
            const diseaseSymptomMap = { 'Fungal infection': ['itching', 'skin_rash', 'nodal_skin_eruptions', 'dischromic_patches'], 'Allergy': ['continuous_sneezing', 'shivering', 'chills', 'watering_from_eyes'], 'GERD': ['stomach_pain', 'acidity', 'ulcers_on_tongue', 'vomiting', 'cough', 'chest_pain'], 'Diabetes ': ['fatigue', 'weight_loss', 'restlessness', 'lethargy', 'irregular_sugar_level', 'blurred_and_distorted_vision', 'excessive_hunger', 'polyuria'], 'Gastroenteritis': ['stomach_pain', 'vomiting', 'dehydration', 'diarrhoea', 'nausea'], 'Hypertension ': ['headache', 'dizziness', 'chest_pain', 'fast_heart_rate'], 'Migraine': ['headache', 'nausea', 'vomiting', 'blurred_and_distorted_vision', 'acidity'], 'Heart attack': ['vomiting', 'breathlessness', 'sweating', 'chest_pain'], 'Pneumonia': ['chills', 'fatigue', 'cough', 'high_fever', 'breathlessness', 'sweating', 'malaise', 'phlegm', 'chest_pain', 'fast_heart_rate', 'rusty_sputum'], 'Common Cold': ['continuous_sneezing', 'chills', 'fatigue', 'cough', 'high_fever', 'headache', 'swelled_lymph_nodes', 'malaise', 'phlegm', 'throat_irritation', 'redness_of_eyes', 'sinus_pressure', 'runny_nose', 'congestion'], 'Jaundice': ['itching', 'vomiting', 'fatigue', 'weight_loss', 'high_fever', 'yellowish_skin', 'dark_urine', 'abdominal_pain'], 'Malaria': ['chills', 'vomiting', 'high_fever', 'sweating', 'headache', 'nausea', 'diarrhoea', 'muscle_pain'], 'Chicken pox': ['itching', 'skin_rash', 'fatigue', 'lethargy', 'high_fever', 'headache', 'loss_of_appetite', 'mild_fever', 'red_spots_over_body'], 'Dengue': ['skin_rash', 'chills', 'joint_pain', 'vomiting', 'fatigue', 'high_fever', 'headache', 'nausea', 'loss_of_appetite', 'pain_behind_the_eyes', 'back_pain', 'malaise', 'red_spots_over_body'], 'Typhoid': ['chills', 'vomiting', 'fatigue', 'high_fever', 'headache', 'nausea', 'constipation', 'abdominal_pain', 'diarrhoea', 'belly_pain'] };
            
            const diseaseSpecialistMap = { 'Fungal infection': 'Dermatologist', 'Allergy': 'Allergist', 'GERD': 'Gastroenterologist', 'Diabetes ': 'Endocrinologist', 'Gastroenteritis': 'Gastroenterologist', 'Hypertension ': 'Cardiologist', 'Migraine': 'Neurologist', 'Heart attack': 'Cardiologist', 'Pneumonia': 'Pulmonologist', 'Common Cold': 'General Physician', 'Jaundice': 'Hepatologist or Gastroenterologist', 'Malaria': 'Infectious Disease Specialist', 'Chicken pox': 'General Physician or Pediatrician', 'Dengue': 'Infectious Disease Specialist', 'Typhoid': 'Infectious Disease Specialist' };

            // --- DOM Elements ---
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const symptomCategoriesContainer = document.getElementById('symptom-categories');
            const symptomSearch = document.getElementById('symptom-search');
            const healthForm = document.getElementById('health-form');
            const chatBox = document.getElementById('chat-box');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const resultsContent = document.getElementById('results-content');
            const diseaseDetailsContainer = document.getElementById('disease-details');
            let predictionChart = null;
            
            // --- APP STATE ---
            let currentSymptoms = [];
            let userDemographics = { age: null, gender: null };

            // --- ADVANCED PREDICTION ENGINE DATA ---
            const diseaseCommonality = { 'Common Cold': 10, 'Allergy': 8, 'Gastroenteritis': 7, 'Migraine': 6, 'Hypertension ': 6, 'GERD': 5, 'Fungal infection': 5, 'Diabetes ': 4, 'Pneumonia': 4, 'Chicken pox': 3, 'Jaundice': 3, 'Typhoid': 2, 'Dengue': 2, 'Malaria': 1, 'Heart attack': 1 };
            const definingSymptoms = { 'pain_behind_the_eyes': 'Dengue', 'irregular_sugar_level': 'Diabetes ', 'yellowish_skin': 'Jaundice', 'continuous_sneezing': 'Allergy' };
            const diseaseAgeGenderFocus = { 'Migraine': { age: [15, 50], gender: ['female'] }, 'Heart attack': { age: [45, 100], gender: ['male'] }, 'Hypertension ': { age: [40, 100] }, 'Chicken pox': { age: [0, 15] }, 'GERD': { age: [30, 70] } };
            const distinguishingSymptoms = { 'Malaria': { question: "Have you experienced shivering or intense chills?", symptom: "shivering" }, 'Dengue': { question: "Are you feeling pain behind your eyes or in your joints?", symptom: "pain_behind_the_eyes" }, 'Common Cold': { question: "Do you have a runny nose or throat irritation?", symptom: "runny_nose" } };
            const mandatorySymptoms = { 'Chicken pox': 'red_spots_over_body', 'Jaundice': 'yellowish_skin', 'Dengue': 'pain_behind_the_eyes', 'Diabetes ': 'irregular_sugar_level' };

            // *** NEW: Severity Classification Data ***
            const redFlagSymptoms = ['chest_pain', 'breathlessness', 'weakness_of_one_body_side', 'altered_sensorium', 'coma', 'stomach_bleeding', 'palpitations', 'fast_heart_rate'];
            const diseaseSeverityMap = {
                'Heart attack': 'Critical', 'Pneumonia': 'Moderate', 'Diabetes ': 'Moderate', 'Hypertension ': 'Moderate',
                'Malaria': 'Moderate', 'Dengue': 'Moderate', 'Typhoid': 'Moderate', 'Jaundice': 'Moderate',
                'GERD': 'Mild', 'Common Cold': 'Mild', 'Allergy': 'Mild', 'Fungal infection': 'Mild',
                'Gastroenteritis': 'Mild', 'Chicken pox': 'Mild', 'Migraine': 'Mild'
            };

            const symptomSpecificity = {};
            const symptomCounts = {};
            for (const disease in diseaseSymptomMap) { diseaseSymptomMap[disease].forEach(symptom => { symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1; }); }
            const totalDiseases = Object.keys(diseaseSymptomMap).length;
            for (const symptom in symptomCounts) { symptomSpecificity[symptom] = Math.log(totalDiseases / symptomCounts[symptom]) + 1; }

            // --- Functions ---
            const resetState = () => {
                currentSymptoms = [];
                userDemographics = { age: null, gender: null };
                if (healthForm) {
                    healthForm.reset();
                    if(symptomSearch) symptomSearch.value = '';
                    filterSymptoms();
                    document.querySelectorAll('#symptom-categories .grid').forEach(content => content.classList.add('hidden'));
                    document.querySelectorAll('#symptom-categories svg').forEach(icon => icon.classList.remove('rotate-180'));
                }
                if (chatBox) {
                    chatBox.innerHTML = '';
                    addChatMessage("Hello! I'm your friendly Arogyam AI. How are you feeling today? Please describe your symptoms.", 'bot');
                }
            };

            const navigateTo = (pageId) => {
                const currentPageEl = document.querySelector('.active-page');
                const currentPageId = currentPageEl ? currentPageEl.id : null;
                if (pageId !== currentPageId && ['home', 'symptom-checker', 'chat-assistant'].includes(pageId)) {
                    resetState();
                }
                pages.forEach(page => page.classList.remove('active-page'));
                document.getElementById(pageId).classList.add('active-page');
                navLinks.forEach(link => {
                    link.classList.remove('nav-link-active');
                     if (link.dataset.page === pageId) { link.classList.add('nav-link-active'); }
                });
                mobileMenu.classList.add('hidden');
                window.scrollTo(0, 0);
            };
            
            const saveFeedback = (disease, rating) => {
                const symptomHash = [...currentSymptoms].sort().join(',');
                if (!symptomHash) return;
                const adjustmentFactor = rating === 'correct' ? 1.2 : 0.5; // Boost by 20% or penalize by 50%
                const feedbackModel = JSON.parse(localStorage.getItem('arogyamFeedback')) || {};
                if (!feedbackModel[symptomHash]) {
                    feedbackModel[symptomHash] = {};
                }
                feedbackModel[symptomHash][disease] = adjustmentFactor;
                localStorage.setItem('arogyamFeedback', JSON.stringify(feedbackModel));
            };

            const showDiseaseDetails = (diseaseName) => {
                const diseaseInfo = diseaseData[diseaseName];
                const specialist = diseaseSpecialistMap[diseaseName] || 'General Physician';
                const allDiseaseSymptoms = diseaseSymptomMap[diseaseName];
                const matchedSymptoms = allDiseaseSymptoms.filter(s => currentSymptoms.includes(s));
                let whyPredictedHtml = `<p class="mb-2 text-slate-600">${diseaseInfo.description}</p><p class="text-slate-600">This was considered a possibility because you reported the following symptom(s) associated with it:</p><ul class="list-disc list-inside mt-2 space-y-1">${matchedSymptoms.map(s => `<li class="capitalize text-green-700 font-semibold">${s.replace(/_/g, ' ')}</li>`).join('')}</ul>`;
                let symptomsHtml = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">${allDiseaseSymptoms.map(s => `<div class="flex items-center"><i data-lucide="${matchedSymptoms.includes(s) ? 'check-circle-2' : 'x-circle'}" class="w-5 h-5 mr-2 ${matchedSymptoms.includes(s) ? 'text-green-600' : 'text-slate-400'}"></i><span class="capitalize ${matchedSymptoms.includes(s) ? 'font-semibold text-slate-800' : 'text-slate-600'}">${s.replace(/_/g, ' ')}</span></div>`).join('')}</div>`;
                const formatList = (items) => `<ul class="list-disc list-inside space-y-2 text-slate-600">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
                diseaseDetailsContainer.innerHTML = `
                    <div class="space-y-8">
                        <div>
                             <button onclick="navigateTo('results-section')" class="flex items-center text-sm text-indigo-600 font-semibold mb-6 hover:underline"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>Back to Analysis Results</button>
                            <h2 class="text-4xl md:text-5xl font-extrabold text-slate-900">${diseaseName}</h2>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h3 class="text-2xl font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="lightbulb" class="w-6 h-6 mr-3 text-indigo-500"></i>Why Arogyam Predicted This</h3>
                            ${whyPredictedHtml}
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                            <h3 class="text-2xl font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="clipboard-list" class="w-6 h-6 mr-3 text-indigo-500"></i>Common Symptoms</h3>
                            ${symptomsHtml}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                                <h3 class="text-2xl font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="leaf" class="w-6 h-6 mr-3 text-green-500"></i>Dietary Suggestions</h3>
                                ${formatList(diseaseInfo.diet)}
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                                <h3 class="text-2xl font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="home" class="w-6 h-6 mr-3 text-yellow-500"></i>Home Remedies</h3>
                                ${formatList(diseaseInfo.remedies)}
                            </div>
                        </div>
                         <div class="bg-gradient-to-r from-indigo-600 to-blue-500 p-8 rounded-xl shadow-xl text-white text-center">
                            <h3 class="text-3xl font-bold mb-4 flex items-center justify-center"><i data-lucide="user-plus" class="w-8 h-8 mr-3"></i>Connect with a Doctor</h3>
                            <p class="mb-6 max-w-xl mx-auto">Professional medical advice is crucial for an accurate diagnosis. Find a ${specialist} near you.</p>
                            <button id="connect-doctor-btn" class="bg-white text-indigo-600 font-bold py-3 px-10 rounded-lg shadow-md hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-indigo-600 focus:ring-white transition-transform transform hover:scale-105 text-lg">Find a ${specialist} Nearby</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('connect-doctor-btn').addEventListener('click', () => {
                    const query = encodeURIComponent(`${specialist} near me`);
                    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
                });
                navigateTo('disease-details');
            };

            const populateSymptoms = () => {
                if (!symptomCategoriesContainer) return;
                symptomCategoriesContainer.innerHTML = '';
                for (const category in symptomCategories) {
                    const accordion = document.createElement('div');
                    accordion.className = 'border border-slate-200 rounded-lg';
                    const symptomsHTML = symptomCategories[category].map(symptom => `<div class="flex items-center symptom-item"><input type="checkbox" id="${symptom}" name="symptoms" value="${symptom}" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><label for="${symptom}" class="ml-3 block text-sm text-slate-700 capitalize">${symptom.replace(/_/g, ' ')}</label></div>`).join('');
                    accordion.innerHTML = `<button type="button" class="w-full flex items-center justify-between p-4 text-left text-slate-700 font-semibold bg-slate-50 hover:bg-slate-100 rounded-t-lg focus:outline-none">${category}<i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-300"></i></button><div class="hidden p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">${symptomsHTML}</div>`;
                    const button = accordion.querySelector('button');
                    const content = accordion.querySelector('div');
                    button.addEventListener('click', () => { content.classList.toggle('hidden'); button.querySelector('svg').classList.toggle('rotate-180'); });
                    symptomCategoriesContainer.appendChild(accordion);
                }
                lucide.createIcons();
            };
            
            const filterSymptoms = () => { const searchTerm = symptomSearch.value.toLowerCase(); document.querySelectorAll('.symptom-item').forEach(item => { const label = item.querySelector('label').textContent.toLowerCase(); item.style.display = label.includes(searchTerm) ? 'flex' : 'none'; }); };
            
            // *** NEW: Severity Classification Function ***
            const classifySeverity = (predictions, selectedSymptoms) => {
                const hasRedFlag = selectedSymptoms.some(symptom => redFlagSymptoms.includes(symptom));
                if (hasRedFlag) return 'Critical';

                if (predictions && predictions.length > 0) {
                    const topDisease = predictions[0];
                    const topDiseaseSeverity = diseaseSeverityMap[topDisease.disease];
                    if (topDiseaseSeverity === 'Critical' && topDisease.confidence > 0.3) return 'Critical';
                    if (topDiseaseSeverity === 'Moderate' && topDisease.confidence > 0.4) return 'Moderate';
                }
                if (selectedSymptoms.length >= 5) return 'Moderate';
                return 'Mild';
            };

            const getPrediction = (selectedSymptoms, age, gender) => {
                const symptomHash = [...selectedSymptoms].sort().join(',');
                const feedbackModel = JSON.parse(localStorage.getItem('arogyamFeedback')) || {};
                const adjustments = feedbackModel[symptomHash] || {};
                const singleSymptomFactor = selectedSymptoms.length === 1 ? 0.3 : 1.0;
                let scores = {};
                for (const disease in diseaseSymptomMap) {
                    if (mandatorySymptoms[disease] && !selectedSymptoms.includes(mandatorySymptoms[disease])) continue;
                    const symptomsForDisease = diseaseSymptomMap[disease];
                    const matchingSymptoms = selectedSymptoms.filter(symptom => symptomsForDisease.includes(symptom));
                    if (matchingSymptoms.length === 0) continue;
                    let matchScore = 0;
                    matchingSymptoms.forEach(symptom => { matchScore += symptomSpecificity[symptom] || 0.1; });
                    let definingBoost = 1.0;
                    matchingSymptoms.forEach(symptom => { if (definingSymptoms[symptom] === disease) definingBoost = 5.0; });
                    let demographicBoost = 1.0;
                    if (age && diseaseAgeGenderFocus[disease]) {
                        const focus = diseaseAgeGenderFocus[disease];
                        if (focus.age && (age >= focus.age[0] && age <= focus.age[1])) demographicBoost *= 1.5;
                        if (gender && focus.gender && focus.gender.includes(gender)) demographicBoost *= 1.5;
                    }
                    const coverageRatio = matchingSymptoms.length / symptomsForDisease.length;
                    const mismatchPenalty = selectedSymptoms.length - matchingSymptoms.length;
                    let finalScore = ((matchScore * coverageRatio * (diseaseCommonality[disease] || 1) * definingBoost * demographicBoost) - mismatchPenalty) * singleSymptomFactor;
                    if (adjustments[disease]) finalScore *= adjustments[disease];
                    if (finalScore > 0) scores[disease] = finalScore;
                }
                const topResults = Object.entries(scores).sort(([, a], [, b]) => b - a).slice(0, 5).map(([disease, score]) => ({ disease, score }));
                if (topResults.length === 0) return { predictions: [], severity: 'Mild' };
                
                const totalScore = topResults.reduce((sum, item) => sum + item.score, 0);
                if (totalScore === 0) return { predictions: topResults.map(item => ({ disease: item.disease, confidence: 0 })), severity: 'Mild' };
                
                const smoothingFactor = totalScore * (selectedSymptoms.length === 1 ? 1.0 : 0.05);
                const softenedTotal = totalScore + smoothingFactor;

                const predictions = topResults.map(item => ({ disease: item.disease, confidence: (item.score / softenedTotal) }));
                const severity = classifySeverity(predictions, selectedSymptoms);

                return { predictions, severity };
            };

            const displayResults = (result) => {
                const { predictions, severity } = result;

                if (!predictions || predictions.length === 0) {
                    resultsContent.innerHTML = `<h2 class="text-4xl font-bold text-center mb-6 text-slate-800">No Matching Conditions Found</h2><div class="bg-white rounded-xl shadow-lg p-10 text-center"><p class="text-slate-600 text-lg">Based on the selected symptoms, we couldn't identify a likely condition. Please consult a doctor for an accurate diagnosis.</p><button onclick="navigateTo('chat-assistant')" class="mt-8 bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700">Chat with AI Assistant</button></div>`;
                    navigateTo('results-section');
                    return;
                }
    
                const chartAndListHtml = `
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center">
                        <div class="lg:col-span-2 relative h-72 md:h-96"><canvas id="prediction-chart"></canvas></div>
                        <div class="lg:col-span-3 space-y-4">
                            <h3 class="text-2xl font-bold text-slate-800">Potential Conditions</h3>
                            <p class="text-slate-500">Click a condition for details. Use the thumbs up/down to rate accuracy and improve future results.</p>
                            <div id="prediction-list" class="space-y-3"></div>
                        </div>
                    </div>`;

                let severityHtml = '';
                switch (severity) {
                    case 'Critical':
                        severityHtml = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-800 p-6 rounded-lg mb-8 shadow-lg">
                                <div class="flex items-center">
                                    <i data-lucide="alert-triangle" class="w-10 h-10 mr-4 text-red-500 flex-shrink-0"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">Critical Alert</h3>
                                        <p class="mt-1 font-semibold">Based on your symptoms, immediate medical attention is strongly advised. This tool is not a substitute for a professional diagnosis.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-8">
                                <h3 class="text-2xl font-bold text-slate-800 mb-4">Emergency Actions</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <a href="tel:112" class="bg-red-600 text-white text-center font-bold py-4 px-6 rounded-lg shadow-md hover:bg-red-700 transition-all flex items-center justify-center text-lg"><i data-lucide="phone-call" class="w-6 h-6 mr-3"></i>Call Emergency</a>
                                    <button id="find-hospitals-btn" class="bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all flex items-center justify-center text-lg"><i data-lucide="hospital" class="w-6 h-6 mr-3"></i>Find Nearby Hospitals</button>
                                </div>
                            </div>`;
                        break;
                    case 'Moderate':
                        severityHtml = `
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg mb-8 shadow-lg">
                                <div class="flex items-center">
                                    <i data-lucide="alert-circle" class="w-10 h-10 mr-4 text-yellow-500 flex-shrink-0"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">Moderate Severity</h3>
                                        <p class="mt-1 font-semibold">Your symptoms suggest a consultation with a healthcare professional is recommended for an accurate diagnosis.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-8 text-center">
                                <h3 class="text-2xl font-bold text-slate-800 mb-4">Next Step</h3>
                                <p class="text-slate-600 mb-6">Create a summary of your session to share with a doctor.</p>
                                <button id="create-summary-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700"><i data-lucide="file-text" class="w-5 h-5 mr-2 inline-block"></i>Create Health Summary</button>
                            </div>`;
                        break;
                    case 'Mild':
                        severityHtml = `
                            <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-6 rounded-lg mb-8 shadow-lg">
                                <div class="flex items-center">
                                    <i data-lucide="check-circle" class="w-10 h-10 mr-4 text-green-500 flex-shrink-0"></i>
                                    <div>
                                        <h3 class="text-2xl font-bold">Mild Severity</h3>
                                        <p class="mt-1 font-semibold">The analysis suggests a mild condition. Explore the results below for self-care tips, but consult a doctor if symptoms worsen.</p>
                                    </div>
                                </div>
                            </div>`;
                        break;
                }

                resultsContent.innerHTML = `
                    <h2 class="text-4xl font-bold text-center mb-10 text-slate-800">Your Health Analysis Report</h2>
                    ${severityHtml}
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-8">
                        ${chartAndListHtml}
                    </div>
                    <div class="mt-12 text-center">
                        <button onclick="navigateTo('home')" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105">Start New Analysis</button>
                    </div>`;

                const newCanvas = document.getElementById('prediction-chart');
                const predictionListContainer = document.getElementById('prediction-list');
                if(predictionChart) predictionChart.destroy();
                predictionChart = new Chart(newCanvas, { type: 'doughnut', data: { labels: predictions.map(p => p.disease), datasets: [{ data: predictions.map(p => (p.confidence * 100)), backgroundColor: ['#4338ca', '#6366f1', '#818cf8', '#a5b4fc', '#c7d2fe'], borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: true, position: 'bottom', labels: { padding: 20, boxWidth: 15, color: '#475569' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${parseFloat(c.raw).toFixed(2)}%` } } } } });
                
                predictionListContainer.innerHTML = '';
                predictions.forEach(p => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'bg-slate-50 border border-slate-200 rounded-lg p-3 hover:bg-indigo-50 hover:border-indigo-300 transition-all flex items-center justify-between';
                    resultCard.innerHTML = `<div class="flex-1 cursor-pointer" onclick="showDiseaseDetails('${p.disease}')"><span class="font-bold text-indigo-700">${p.disease}</span></div><div class="flex items-center space-x-4 ml-4"><span class="font-semibold text-slate-800 w-16 text-right">${(p.confidence * 100).toFixed(1)}%</span><div class="rating-buttons flex items-center space-x-1" data-disease="${p.disease}"><button class="p-1.5 rounded-full hover:bg-green-200 text-slate-400 hover:text-green-600 transition-colors" data-rating="correct" title="This seems correct"><i data-lucide="thumbs-up" class="w-5 h-5"></i></button><button class="p-1.5 rounded-full hover:bg-red-200 text-slate-400 hover:text-red-600 transition-colors" data-rating="incorrect" title="This seems incorrect"><i data-lucide="thumbs-down" class="w-5 h-5"></i></button></div></div>`;
                    predictionListContainer.appendChild(resultCard);
                });

                lucide.createIcons();
                
                document.querySelectorAll('.rating-buttons button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const parent = button.closest('.rating-buttons');
                        const disease = parent.dataset.disease;
                        const rating = button.dataset.rating;
                        saveFeedback(disease, rating);
                        parent.innerHTML = '<span class="text-sm text-green-700 font-semibold px-2">Thanks!</span>';
                    });
                });

                const findHospitalsBtn = document.getElementById('find-hospitals-btn');
                if (findHospitalsBtn) {
                    findHospitalsBtn.addEventListener('click', () => window.open('https://www.google.com/maps/search/?api=1&query=hospitals+near+me', '_blank'));
                }
                const createSummaryBtn = document.getElementById('create-summary-btn');
                if (createSummaryBtn) {
                    createSummaryBtn.addEventListener('click', () => {
                        const summary = `## Arogyam Health Summary ##\n\n**Demographics:**\n- Age: ${userDemographics.age || 'N/A'}\n- Gender: ${userDemographics.gender ? userDemographics.gender.charAt(0).toUpperCase() + userDemographics.gender.slice(1) : 'N/A'}\n\n**Reported Symptoms:**\n${currentSymptoms.map(s => `- ${s.replace(/_/g, ' ')}`).join('\n')}\n\n**AI Analysis (Potential Conditions):**\n${predictions.map(p => `- ${p.disease} (${(p.confidence * 100).toFixed(1)}% confidence)`).join('\n')}\n\nDisclaimer: This is an AI-generated summary and not a medical diagnosis.`;
                        const summaryModal = document.createElement('div');
                        summaryModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4';
                        summaryModal.innerHTML = `<div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col"><div class="p-4 border-b flex justify-between items-center"><h3 class="text-xl font-bold">Health Summary</h3><button class="close-modal-btn text-slate-500 hover:text-slate-800 text-2xl">&times;</button></div><div class="p-6 overflow-y-auto custom-scrollbar"><pre class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap font-sans text-sm">${summary.trim()}</pre></div><div class="p-4 border-t text-right bg-slate-50"><button class="close-modal-btn bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600">Close</button></div></div>`;
                        document.body.appendChild(summaryModal);
                        summaryModal.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => summaryModal.remove()));
                    });
                }
                navigateTo('results-section');
            };
            
            const addChatMessage = (message, sender, isTyping = false, contentHTML = null) => {
                const existingTyping = chatBox.querySelector('.typing-indicator-bubble');
                if (existingTyping) existingTyping.remove();
                const bubble = document.createElement('div');
                if (isTyping) {
                    bubble.className = `chat-bubble bot-bubble p-4 flex items-center space-x-3 typing-indicator-bubble`;
                    bubble.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5 text-slate-600"></i></div><div class="typing-indicator"><span></span><span></span><span></span></div>`;
                } else {
                    bubble.className = `chat-bubble p-4 ${sender === 'user' ? 'user-bubble' : 'bot-bubble flex items-start space-x-3'}`;
                    if (sender === 'bot') {
                        const content = contentHTML ? contentHTML : `<p class="pt-1">${message}</p>`;
                        bubble.innerHTML = `<div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5 text-slate-600"></i></div><div class="flex-1">${content}</div>`;
                    } else {
                        bubble.textContent = message;
                    }
                }
                chatBox.appendChild(bubble);
                lucide.createIcons();
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            const askFollowUpQuestions = (result) => {
                const { predictions } = result;
                const topDiseases = predictions.slice(0, 3).map(p => p.disease);
                const questionsToAsk = new Set();
                topDiseases.forEach(disease => {
                    if (distinguishingSymptoms[disease] && !currentSymptoms.includes(distinguishingSymptoms[disease].symptom)) {
                        questionsToAsk.add(JSON.stringify(distinguishingSymptoms[disease]));
                    }
                });
                if (questionsToAsk.size > 0) {
                    let questionHTML = `<div class="pt-1 space-y-3"><p>To help me be more accurate, could you answer a few more questions?</p><div class="flex flex-col space-y-2">`;
                    questionsToAsk.forEach(qStr => { const q = JSON.parse(qStr); questionHTML += `<button class="follow-up-btn text-left text-sm text-indigo-700 bg-indigo-100 hover:bg-indigo-200 p-2 rounded-lg" data-symptom="${q.symptom}">${q.question}</button>`; });
                    questionHTML += `<button class="follow-up-btn text-left text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 p-2 rounded-lg" data-symptom="none">None of these apply</button></div></div>`;
                    addChatMessage('', 'bot', false, questionHTML);
                    document.querySelectorAll('.follow-up-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const addedSymptom = btn.dataset.symptom;
                            btn.closest('.chat-bubble .flex-1').innerHTML = `<p class="pt-1 text-slate-500 italic">Thank you for the information.</p>`;
                            if (addedSymptom !== 'none') {
                                currentSymptoms.push(addedSymptom);
                                addChatMessage(`Okay, adding "${addedSymptom.replace(/_/g, ' ')}" to my analysis.`, 'user');
                            } else { addChatMessage(`Understood, none of those apply.`, 'user'); }
                            addChatMessage('', 'bot', true);
                            setTimeout(() => {
                                addChatMessage('Recalculating based on the new information...', 'bot');
                                const newPredictions = getPrediction(currentSymptoms, userDemographics.age, userDemographics.gender);
                                displayResults(newPredictions);
                            }, 1500);
                        });
                    });
                    return true;
                }
                return false;
            };

            const getChatbotResponse = (userInput) => {
                addChatMessage('', 'bot', true);
                const detected = allSymptoms.filter(symptom => userInput.toLowerCase().includes(symptom.replace(/_/g, ' ')));
                currentSymptoms.push(...detected);
                currentSymptoms = [...new Set(currentSymptoms)];
                setTimeout(() => {
                    if (currentSymptoms.length === 0) {
                        addChatMessage("I'm sorry, I couldn't identify specific medical symptoms. Could you please try describing them again. For example, 'I have a high fever and a sore throat'.", 'bot');
                        return;
                    }
                    if (!userDemographics.age || !userDemographics.gender) {
                        addChatMessage('Thank you. To make the analysis more accurate, could you please tell me your age and gender? For example: "I am a 35 year old male".', 'bot');
                        return;
                    }
                    addChatMessage(`Thanks! Analyzing for a ${userDemographics.age}-year-old ${userDemographics.gender} with symptoms: ${currentSymptoms.map(s=>s.replace(/_/g,' ')).join(', ')}.`, 'bot');
                    setTimeout(() => { 
                        const result = getPrediction(currentSymptoms, userDemographics.age, userDemographics.gender);
                        if (currentSymptoms.length <= 2 && askFollowUpQuestions(result)) return;
                        displayResults(result);
                    }, 1500);
                }, 1200);
            };
            
            // --- Event Listeners & Initialization ---
            lucide.createIcons();
            populateSymptoms();
            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); }));
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            if(symptomSearch) symptomSearch.addEventListener('input', filterSymptoms);
            if(healthForm) healthForm.addEventListener('submit', (e) => { e.preventDefault(); const formData = new FormData(healthForm); const selectedSymptoms = formData.getAll('symptoms'); if (selectedSymptoms.length < 1) { return; } currentSymptoms = selectedSymptoms; userDemographics.age = formData.get('age'); userDemographics.gender = formData.get('gender'); displayResults(getPrediction(currentSymptoms, userDemographics.age, userDemographics.gender)); });
            
            if(chatForm) {
                addChatMessage("Hello! I'm your friendly Arogyam AI. How are you feeling today? Please describe your symptoms.", 'bot');
                chatForm.addEventListener('submit', (e) => { 
                    e.preventDefault(); 
                    const userInput = chatInput.value.trim(); 
                    if (userInput) { 
                        addChatMessage(userInput, 'user'); 
                        chatInput.value = ''; 
                        const ageMatch = userInput.match(/(\d+)\s*year/);
                        const genderMatch = userInput.match(/male|female|other/i);
                        if (ageMatch) userDemographics.age = parseInt(ageMatch[1]);
                        if (genderMatch) userDemographics.gender = genderMatch[0].toLowerCase();
                        getChatbotResponse(userInput); 
                    } 
                });
            }
            window.navigateTo = navigateTo;
            window.showDiseaseDetails = showDiseaseDetails;
        });
    </script>
</body>
</html>

